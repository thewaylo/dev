<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
       
         <!-- CSS Files -->
        <link href="css/bootstrap.css" rel="stylesheet" media="screen">
        <link href="css/font-awesome.min.css" rel="stylesheet">
         <!-- Colors -->
        <link href="css/css-index.css" rel="stylesheet" media="screen">
        <!-- <link href="css/css-index-green.css" rel="stylesheet" media="screen"> -->
        <!-- <link href="css/css-index-purple.css" rel="stylesheet" media="screen"> -->
        <!-- <link href="css/css-index-red.css" rel="stylesheet" media="screen"> -->
         <link href="css/css-index-orange.css" rel="stylesheet" media="screen"> 
        <!-- <link href="css/css-index-yellow.css" rel="stylesheet" media="screen"> -->
    </head>
    <body>
     <script src="js/jquery.js"></script>
        <script src="js/bootstrap.min.js"></script>
    <!-- NAVIGATION -->
	     <div id="menu">
            <nav class="navbar-wrapper navbar-default" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-backyard">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand site-name" href="./index.html"><img src="images/waylo_logo.png" alt="logo"></a>
                    </div>

                    <div id="navbar-scroll" class="collapse navbar-collapse navbar-backyard navbar-right">
                        <ul class="nav navbar-nav">
                            <li><a href="./index.html#intro">About</a></li>
                            <li><a href="./index.html#feature">Features</a></li>
                            <!--<li><a href="./index.html#contact">Contact</a></li>-->
                            <!--<li><a href="#">Docs</a></li>-->
                            
                            <li><a href="./faq.html">FAQ</a></li>
                            <li><a href="./index.html#login">Sign Up</a></li>
                            
                        </ul>
                    </div>
                </div>
            </nav>
        </div> 
  <div class="fullscreen landing parallax" style="background-image:url('images/bg.svg');" >
    <div class="container" style="margin-top:100px;">
      <!-- Nav tabs -->
  <ul id="platform" class="nav nav-tabs" role="tablist" style="margin-top:-50px;margin-bottom:20px;">
    <li class="nav-item active">
      <a class="nav-link active" style="color:#55595c !important" data-toggle="tab" href="#facebook" role="tab">Facebook Messenger</a>
    </li>
    <!--<li class="nav-item">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#slack" role="tab">Slack</a>-->
    <!--</li>-->
    <!--<li class="nav-item">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#google" role="tab">Google Assistant</a>-->
    <!--</li>-->
    <!--<li class="nav-item">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#wechat" role="tab">WeChat</a>-->
    <!--</li>-->
    <!--<li class="nav-item">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#kik" role="tab">Kik</a>-->
    <!--</li>-->
    <!--<li class="nav-item">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#viber" role="tab">Viber</a>-->
    <!--</li>-->
    <!-- <li class="nav-item">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#line" role="tab">Line</a>-->
    <!--</li>-->
    <!--<li class="nav-item">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#twilio" role="tab">Twilio Sms</a>-->
    <!--</li>-->
    <!--<li class="nav-item" stype="display:none;">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#microsoft" role="tab">Microsoft Bot Framework</a>-->
    <!--</li>-->
    <!-- <li class="nav-item" stype="display:none;">
      <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#smooch" role="tab">Smooch</a>
    </li>-->
    <!--<li class="nav-item">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#generic" role="tab">Generic</a>-->
    <!--</li>-->
    <!--<li class="nav-item">-->
    <!--  <a class="nav-link " style="color:#55595c !important" data-toggle="tab" href="#live" role="tab">Live Chat</a>-->
    <!--</li>-->
  </ul>
  <!-- Tab panes -->
 <div class="tab-content">
   <div class="tab-pane active" id="facebook" role="tabpanel">
     <!--<h1 class = "docu-main-h">Documentation</h1>-->
     <h2 class="docu-header" style="font-size:22px;margin-bottom:30px;">Messages</h2>
     <h2 class="docu-header">Parameters</h2>
     <p class="docu-p">Obtain your <code>API KEY</code> and submit your <code>MESSENGER PAGE ACCESS TOKEN</code>,<code>PAUSE WEBHOOK</code> prior to integration</p>
     <h2 class="docu-header">Rate Limits</h2>
     <p class="docu-p">The test version of Waylo API is limited to 3 requests/second and 50,000 requests/day</p>

     <h2 class="docu-header">Request</h2>
     <p class="docu-p">In order to send incoming/out-going messages to Waylo, make a  <code>POST</code>call to<code>https://wayloapi.herokuapp.com/webhook</code></p>
     <h3 class="docu-m-header">Example</h3>
     <pre class="docu-pre">         <span class="docu-w-sp">
curl <span class="docu-gr-sp"> "https://wayloapi.herokuapp.com/webhook?apikey=[YOUR KEY]&amp;paused=[pausedState=true/false]"</span> \
-X POST \
-H 'Content-Type: application/json' \
-d
'{
    "message": see below incoming/out-going message structures.
}'             </span>
</pre>
     <h3 class="docu-m-header">Fields</h3>
     <table class="table table-striped table-bordered table-sm">
       <thead>
         <tr>
           <th>Field Name</th>
           <th>Description</th>
           <th>Type</th>
           <th>Required</th>
         </tr>
       </thead>
       <tbody>
         <tr>
           <td style="color:#42b72a">message</td>
           <td>Message</td>
           <td>JSON</td>
           <td>Yes</td>
         </tr>
         <!--<tr>-->
         <!--  <td style = "color:#42b72a">recipient</td>-->
         <!--  <td>Recipient</td>-->
         <!--  <td>String</td>-->
         <!--   <td>Yes</td>-->
         <!--</tr>4-->

         <!--<tr>-->
         <!--  <td style = "color:#42b72a">timestamp</td>-->
         <!--  <td>Timestamp</td>-->
         <!--  <td>Number</td>-->
         <!--   <td>Yes</td>-->
         <!--</tr>-->
         <!--<tr>-->
         <!--  <td style = "color:#42b72a">notification_type</td>-->
         <!--  <td>Notification Type</td>-->
         <!--  <td>Push notification type: REGULAR, SILENT_PUSH, NO_PUSH</td>-->
         <!--  <td>No</td>-->
         <!--</tr>-->
       </tbody>
     </table>





     <h4 class="docu-m-header">Simple Node.js code example</h4>
     <!--<p class = "docu-p">Below you can see a function track is defined and called for incoming and out-going messages. </p>-->
     <pre class="docu-pre" style="padding-top:20px;padding-bottom:0px;">     <span class="docu-gr-sp-r" style="margin-left:-30px;"><span class="docu-w-sp-r"></span>
var request = require('request');

/******************** Waylo function with the API endpoint       **************/

function wayloapi(message){

  // Extract userid from message
  
  const userid = message.entry[0].id===message.entry[0].messaging[0].sender.id? message.entry[0].messaging[0].recipient.id : message.entry[0].messaging[0].sender.id;
  
  // Retrieve the paused state. Change this line if you implemented paused variable in your database
  var pausedState = pausedUsers[userid] ? pausedUsers[userid] : false;
  var options = { method: 'POST',
    url: 'https://wayloapi.herokuapp.com/webhook',                              //URL is different for production API
    qs: {
      apikey: <your api="" key="">,
      paused: pausedState
    },
    headers: 
     {'content-type': 'application/json' },
    body: message,
    json: true };

  request(options, function(error, response, body){

         if(error) {
           console.log(error)
         } else {
           console.log(response.statusCode, body)
         }
    });

}



/**** Log incoming messages and postbacks *********/

app.post('/webhook', function (req, res) {
  var data = req.body;
  wayloapi(req.body);                                             // logging inputs


  if (data.object == 'page') {
    // Iterate over each entry
    // There may be multiple if batched
    data.entry.forEach(function(pageEntry) {
      var pageID = pageEntry.id;
      var timeOfEvent = pageEntry.time;

      // Iterate over each messaging event
      pageEntry.messaging.forEach(function(messagingEvent) {

        const senderID=  messagingEvent.sender.id;

        if(!pausedUsers[senderID]){                               // Note the bot pause part
          if (messagingEvent.optin) {
            receivedAuthentication(messagingEvent);
          } else if (messagingEvent.message) {
            receivedMessage(messagingEvent);
          } else if (messagingEvent.delivery) {
            receivedDeliveryConfirmation(messagingEvent);
          } else if (messagingEvent.postback) {
            receivedPostback(messagingEvent);
          } else if (messagingEvent.read) {
            receivedMessageRead(messagingEvent);
          } else if (messagingEvent.account_linking) {
            receivedAccountLink(messagingEvent);
          } else {
            console.log("Webhook received unknown messagingEvent: ", messagingEvent);
          }
        }
      });
    });

    // Assume all went well.
    //
    // You must send back a 200, within 20 seconds, to let us know you've 
    // successfully received the callback. Otherwise, the request will time out.
    res.sendStatus(200);
  }
});




/***************Bot pause ******************************/

var jsonParser = bodyParser.json();

// Test Bot pause

app.get('/pause', function(req, res) {
    console.log("pause");
    res.send(200);    
});


var pausedUsers = {};  // Implement this in the datebase to make it more robust
app.post('/pause', jsonParser, function (req, res) {
  const userId = req.query.userId;
  const paused = (req.query.paused === "true");
  pausedUsers[userId] = paused;                      
  res.send("ok")
})



/*************Button to pause bot and start Waylo Hotel booking *********/

var buttonData = {
  recipient: {
    id: userId                             // Make sure this is the id of the user
  },
  message: {
    attachment: {
      type: "template",
      payload: {
        template_type: "button",
        text: 'Ciao until next time :)',    // Bot maker is free to choose this text
        buttons:[ 
        {
          type: "postback",
          title: "Book hotel",              // Bot maker is free to choose this text
          payload: "pause=hotel"            // Do not change payload. Handle the payload in your logic if can
          
        }

        ]
      }
    }
  }
};  

callSendAPI(buttonData);                   // Call Messenger API




/********************* callSendAPI (Messenger API call) **************/


function callSendAPI(messageData) {
  wayloapi(messageData)                                          // Log outgoing message
  request({
    uri: 'https://graph.facebook.com/v2.8/me/messages',
    qs: { access_token: PAGE_ACCESS_TOKEN },
    method: 'POST',
    json: messageData

  }, function (error, response, body) {
    if (!error &amp;&amp; response.statusCode == 200) {
      var recipientId = body.recipient_id;
      var messageId = body.message_id;

      if (messageId) {
        console.log("Successfully sent message with id %s to recipient %s", 
          messageId, recipientId);
      } else {
      console.log("Successfully called Send API for recipient %s", 
        recipientId);
      }
    } else {
      console.error("Failed calling Send API", response.statusCode, response.statusMessage, body.error);
    }
  });  
}

     </your></span></pre>
     <h2 class="docu-header" style="font-size:22px;margin-bottom:30px;margin-top:40px;">Response Meanings</h2>
     <table class="table table-striped table-bordered table-sm">
       <thead>
         <tr>
           <th>Response Code</th>
           <th>Meaning</th>
         </tr>
       </thead>
       <tbody>
         <tr>
           <td style="color:#222;font-weight:500;">200</td>
           <td>OK – Everything worked as expected.</td>
         </tr>
         <tr>
           <td style="color:#222;font-weight:500;">400</td>
           <td>Bad Request – The request was unacceptable, often due to missing a required parameter.</td>
         </tr>
         <tr>
           <td style="color:#222;font-weight:500;">401</td>
           <td>Unauthorized – Your api token is wrong</td>
         </tr>
         <tr>
           <td style="color:#222;font-weight:500;">404</td>
           <td>Not Found – The requested resource doesn't exist.</td>
         </tr>
         <tr>
           <td style="color:#222;font-weight:500;">500, 502, 503, 504</td>
           <td>Server Errors – Something went wrong on Waylo's end. Try again later. (These are rare.) </td>
         </tr>
       </tbody>
     </table>
 </div>

 <script>
 $('#platform a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
});
$('#google-platform a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
});
 </script>
  


</div>
</div>
  </div>
    </body>
</html>